<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Structured Note Overview</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-page: #f3f4f6;
      --bg-card: #ffffff;
      --border-subtle: #e5e7eb;
      --border-strong: #d1d5db;
      --accent: #2563eb;
      --accent-soft: #eff6ff;
      --text-main: #111827;
      --text-muted: #6b7280;
      --font: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: var(--font);
      background: var(--bg-page);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      padding: 24px 16px;
    }

    .shell {
      width: 100%;
      max-width: 1120px;
      background: #f9fafb;
      border-radius: 16px;
      padding: 18px 20px 20px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 20px 40px rgba(15,23,42,0.06);
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: var(--accent-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent);
      font-weight: 600;
      font-size: 16px;
      border: 1px solid #bfdbfe;
    }

    .brand-text h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .brand-text p {
      margin: 2px 0 0;
      font-size: 13px;
      color: var(--text-muted);
    }

    .top-note {
      font-size: 12px;
      color: var(--text-muted);
      text-align: right;
    }

    main {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 4px;
    }

    .card {
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      padding: 12px 14px;
      box-shadow: 0 1px 2px rgba(15,23,42,0.04);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .badge-soft {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e5e7eb;
      color: #374151;
      border: 1px solid #d1d5db;
      white-space: nowrap;
    }

    .search-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    label {
      font-size: 12px;
      color: #374151;
      margin-bottom: 4px;
      display: block;
      font-weight: 500;
    }

    .input {
      border-radius: 8px;
      border: 1px solid var(--border-strong);
      background: #ffffff;
      padding: 8px 10px;
      font-size: 13px;
      flex: 1;
      min-width: 200px;
    }

    .input::placeholder {
      color: #9ca3af;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border-radius: 8px;
      border: 1px solid transparent;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      background: var(--accent);
      color: #ffffff;
      white-space: nowrap;
      transition: background 0.1s ease, border-color 0.1s ease;
    }

    .btn:hover {
      background: #1d4ed8;
    }

    .btn.secondary {
      background: #ffffff;
      color: #374151;
      border-color: var(--border-strong);
    }

    .btn.secondary:hover {
      background: #f3f4f6;
    }

    .hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .toolbar-left {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .toolbar-right {
      font-size: 12px;
      color: var(--text-muted);
    }

    .select {
      border-radius: 8px;
      border: 1px solid var(--border-strong);
      background: #ffffff;
      padding: 6px 10px;
      font-size: 12px;
      color: var(--text-main);
    }

    .overview-card {
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      padding: 10px 12px;
      box-shadow: 0 1px 2px rgba(15,23,42,0.04);
    }

    .table-wrapper {
      overflow-x: auto;
      margin-top: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      background: #f3f4f6;
    }

    th,
    td {
      padding: 6px 8px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
      vertical-align: top;
    }

    th {
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 500;
      white-space: nowrap;
    }

    td {
      font-size: 12px;
    }

    .issuer-cell {
      font-weight: 500;
      font-size: 12px;
    }

    .cell-muted {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .pill {
      display: inline-flex;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      font-size: 11px;
      color: #374151;
    }

    .pill.callable {
      border-color: #a7f3d0;
      background: #ecfdf3;
      color: #047857;
    }

    .pill.point {
      border-color: #bfdbfe;
      background: #eff6ff;
      color: #1d4ed8;
    }

    .empty-state {
      font-size: 12px;
      color: var(--text-muted);
      text-align: center;
      padding: 16px 0;
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div class="brand">
        <div class="brand-logo">SN</div>
        <div class="brand-text">
          <h1>Structured Note Overview</h1>
          <p>Grid view of key terms by CUSIP.</p>
        </div>
      </div>
      <div class="top-note">
        Prototype &nbsp;·&nbsp; Data sources: SEC filings (via API)
      </div>
    </header>

    <main>
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Add CUSIPs</div>
            <div class="card-subtitle">
              Enter one or more CUSIPs to populate the overview table.
            </div>
          </div>
          <span class="badge-soft">Overview table</span>
        </div>

        <div>
          <label for="cusip-input">CUSIP(s)</label>
          <div class="search-row">
            <input
              id="cusip-input"
              class="input"
              placeholder="e.g. 48136H7D4 or 48136H7D4, 48134K541"
            />
            <button id="add-btn" class="btn">Add to table</button>
            <button id="clear-btn" class="btn secondary">Clear all</button>
          </div>
          <div class="hint">
            You can paste multiple CUSIPs separated by commas. Each CUSIP will be
            looked up via the /api/analyze-cusip endpoint.
          </div>
        </div>

        <div class="toolbar">
          <div class="toolbar-left">
            <label for="type-filter" style="margin: 0; font-weight: 400;">Filter by profile:</label>
            <select id="type-filter" class="select">
              <option value="all">All notes</option>
              <option value="point">Point-to-point</option>
              <option value="callable">Callable</option>
            </select>
          </div>
          <div class="toolbar-right">
            <span id="count-label">No CUSIPs added yet.</span>
          </div>
        </div>
      </section>

      <section class="overview-card">
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>CUSIP</th>
                <th>Issuer</th>
                <th>Underliers</th>
                <th>Initial values</th>
                <th>Payout profile</th>
                <th>Initial est. value</th>
                <th>Total fees</th>
                <th>Final observation date</th>
                <th>Type</th>
              </tr>
            </thead>
            <tbody id="notes-body">
              <tr>
                <td colspan="9" class="empty-state">
                  No CUSIPs added yet. Add one above to see it here.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <script>
    const cusipInput = document.getElementById('cusip-input');
    const addBtn = document.getElementById('add-btn');
    const clearBtn = document.getElementById('clear-btn');
    const typeFilter = document.getElementById('type-filter');
    const notesBody = document.getElementById('notes-body');
    const countLabel = document.getElementById('count-label');

    // NEW: call the live /api/analyze-cusip endpoint for a single CUSIP
    async function fetchNoteForCusip(cusipRaw) {
      const cusip = cusipRaw.trim().toUpperCase();
      if (!cusip) return null;

      try {
        const resp = await fetch(`/api/analyze-cusip?cusip=${encodeURIComponent(cusip)}`);
        if (!resp.ok) {
          console.error('API error for CUSIP', cusip, resp.status);
          return {
            cusip,
            issuer: 'Filing not found',
            underliers: {
              description: 'No SEC filing located',
              detail: 'The CUSIP did not return a filing from the search API.'
            },
            initialValues: '—',
            payoutProfile: '—',
            initialEstValue: '—',
            totalFees: '—',
            finalObs: '—',
            type: 'point'
          };
        }

        const data = await resp.json();
        const m = data.filingMeta || {};

        return {
          cusip,
          issuer: m.companyName || 'Unknown issuer',
          underliers: {
            description: 'To be parsed from filing',
            detail: [
              m.formType || '',
              m.filedAt ? `filed ${m.filedAt}` : ''
            ].filter(Boolean).join(' · ')
          },
          initialValues: 'To be parsed',
          payoutProfile: 'To be parsed',
          initialEstValue: 'To be parsed',
          totalFees: 'To be parsed',
          finalObs: 'To be parsed',
          // For now, treat all as "callable" so they show up in that filter too.
          // Later we’ll classify based on the parsed terms from ChatGPT.
          type: 'callable'
        };
      } catch (err) {
        console.error('Error calling /api/analyze-cusip', err);
        return null;
      }
    }

    const state = {
      notes: [] // array of note objects returned by fetchNoteForCusip
    };

    function renderTable() {
      const filter = typeFilter.value;
      let visible = state.notes;

      if (filter === 'point') {
        visible = visible.filter(n => n.type === 'point');
      } else if (filter === 'callable') {
        visible = visible.filter(n => n.type === 'callable');
      }

      notesBody.innerHTML = '';

      if (visible.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td colspan="9" class="empty-state">
            ${
              state.notes.length
                ? 'All rows filtered out. Adjust filters to see notes.'
                : 'No CUSIPs added yet.'
            }
          </td>
        `;
        notesBody.appendChild(tr);
        countLabel.textContent =
          state.notes.length === 0
            ? 'No CUSIPs added yet.'
            : `0 of ${state.notes.length} notes in view (filter applied).`;
        return;
      }

      visible.forEach(note => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${note.cusip}</td>
          <td>
            <div class="issuer-cell">${note.issuer}</div>
          </td>
          <td>
            <div>${note.underliers.description}</div>
            <div class="cell-muted">${note.underliers.detail}</div>
          </td>
          <td>${note.initialValues}</td>
          <td>${note.payoutProfile}</td>
          <td>${note.initialEstValue}</td>
          <td>${note.totalFees}</td>
          <td>${note.finalObs}</td>
          <td>
            <span class="pill ${note.type === 'callable' ? 'callable' : 'point'}">
              ${note.type === 'callable' ? 'Callable' : 'Point-to-point'}
            </span>
          </td>
        `;
        notesBody.appendChild(tr);
      });

      const total = state.notes.length;
      const shown = visible.length;
      countLabel.textContent =
        shown === total
          ? `${shown} note${shown === 1 ? '' : 's'} in view.`
          : `${shown} of ${total} note${total === 1 ? '' : 's'} in view.`;
    }

    addBtn.addEventListener('click', async () => {
      const input = cusipInput.value;
      if (!input.trim()) return;

      const parts = input.split(',');
      for (const p of parts) {
        const note = await fetchNoteForCusip(p);
        if (!note) continue;
        // avoid duplicates by CUSIP
        if (!state.notes.find(n => n.cusip === note.cusip)) {
          state.notes.push(note);
        }
      }

      renderTable();
    });

    clearBtn.addEventListener('click', () => {
      state.notes = [];
      renderTable();
    });

    typeFilter.addEventListener('change', renderTable);

    cusipInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') addBtn.click();
    });

    renderTable();
  </script>
</body>
</html>
